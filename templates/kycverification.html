<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <link rel="stylesheet" href="{% static 'kyc.css' %}">
    <script src="{% static 'kycWorkingType.js' %}"></script>
    {% comment %} <link rel="stylesheet" href="{% static 'style.css' %}"> {% endcomment %}
    <title>KYC Verification | HandiQ</title>
    
</head>

<body>
    <div class="kyc-container">
        <h1>KYC Verification</h1>
        <input type="hidden" id="submission-flag" value="{% if submitted %}true{% else %}false{% endif %}">
        <div id="message-container" style="display:none; padding:10px; margin-bottom:15px; border-radius:5px;"></div>
        <form class="kyc-form" id="kyc-form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="text" id="kyc-name" name="name" placeholder="Name" required>
            <input type="text" id="kyc-address" name="address" placeholder="Address" required>
            

            <label>Choose Service Types</label>

            <select id="service-type-select" name="service_type[]" multiple required style="width:100%">
                <option value="Carpenter">Carpenter</option>
                <option value="Painter">Painter</option>
                <option value="Electrician">Electrician</option>
                <option value="Plumber">Plumber</option>
            </select>




            <!-- Working Type Field with Checkboxes -->
            <div class="upload-container">
                <label style="width: 100%; margin-bottom: 10px;">Choose Your Income Type</label>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="hourly-checkbox" name="hourly" value="Hourly">
                            <span>Hourly</span>
                        </label>
                        <div id="hourly-amount-container" style="display: none; align-items: center; gap: 10px; margin-left: 25px;">
                            <label for="hourly-amount" style="white-space: nowrap;">Amount (Rs):</label>
                            <input type="number" id="hourly-amount" name="hourly_amount" placeholder="Enter hourly amount" min="0" step="0.01" style="width: 150px;">
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="onetime-checkbox" name="onetime" value="One Time">
                            <span>One Time</span>
                        </label>
                        <div id="onetime-amount-container" style="display: none; align-items: center; gap: 10px; margin-left: 25px;">
                            <label for="onetime-amount" style="white-space: nowrap;">Amount (Rs):</label>
                            <input type="number" id="onetime-amount" name="onetime_amount" placeholder="Enter one-time amount" min="0" step="0.01" style="width: 150px;">
                        </div>
                    </div>
                </div>
                <input type="hidden" id="working-type" name="woork_type" required>
            </div>

            <!-- Photo Upload -->
            <div class="upload-container">
                <label for="kyc-photo">Upload Photo</label>
                <input type="file" id="kyc-photo" name="photo" accept="image/*" required>
                <img id="photo-preview" src="" alt="Photo Preview" style="display:none; max-width:150px; margin-top:10px; border:1px solid #ccc;">
            </div>

            <!-- Citizenship Number -->
            <input type="text" id="kyc-citizenship" name="citizenship_number" placeholder="Citizenship Number" required>

            <!-- Citizenship Photo Upload -->
            <div class="upload-container">
                <label for="kyc-citizenship-photo">Upload Citizenship Photo</label>
                <input type="file" id="kyc-citizenship-photo" name="citizenship_photo" accept="image/*" required>
                <img id="citizenship-preview" src="" alt="Citizenship Photo Preview" style="display:none; max-width:150px; margin-top:10px; border:1px solid #ccc;">
            </div>

            <!-- Training Certificate Upload -->
            <div class="upload-container">
                <label for="Training Certificate">Upload Certificate Photo</label>
                <input type="file" id="kyc-TrainingCertificate-photo" name="training_certificate" accept="image/*" required>
                <img id="certificate-preview" src="" alt="Certificate Photo Preview" style="display:none; max-width:150px; margin-top:10px; border:1px solid #ccc;">
            </div>

            <button type="submit">Submit</button>
        </form>
    </div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("kyc-form");
    const messageContainer = document.getElementById("message-container");

    // Initialize Select2
    $('#service-type-select').select2({
        placeholder: "Select service type",
        maximumSelectionLength: 4,
        tags: false // disables user typing custom text
    });

    // Live preview for photo uploads
    document.getElementById("kyc-photo").addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById("photo-preview").src = event.target.result;
                document.getElementById("photo-preview").style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById("kyc-citizenship-photo").addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById("citizenship-preview").src = event.target.result;
                document.getElementById("citizenship-preview").style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById("kyc-TrainingCertificate-photo").addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById("certificate-preview").src = event.target.result;
                document.getElementById("certificate-preview").style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(form);

        // Convert selected services to comma-separated string (like update_kyc.html)
        const selectedServices = $('#service-type-select').val() || [];
        formData.set('service_type', selectedServices.join(','));

        // Ensure working type is set before submission
        const workingTypeInput = document.getElementById("working-type");
        if (window.updateWorkingType) {
            window.updateWorkingType();
        }
        if (!workingTypeInput || !workingTypeInput.value.trim()) {
            showMessage("Please select at least one income type (Hourly or One Time).", "red");
            // Scroll to top to show error message
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return;
        }

        // Remove checkbox and amount fields from formData (we use the hidden woork_type field)
        formData.delete('hourly');
        formData.delete('onetime');
        formData.delete('hourly_amount');
        formData.delete('onetime_amount');

        // Get the token from localStorage (set at login)
        const token = localStorage.getItem("token");

        if (!token) {
            showMessage("You are not logged in. Please log in first.", "red");
            // Scroll to top to show error message
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return;
        }

        try {
            const response = await fetch("/api/kyc-verification/", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": document.querySelector("input[name=csrfmiddlewaretoken]").value,
                    "Authorization": `Token ${token}` // Send the token from localStorage
                }
            });

            const data = await response.json();

            if (response.ok) {
                showMessage(data.message || data.success || "KYC submitted successfully!", "green");
                // Scroll to top after successful submission
                window.scrollTo({ top: 0, behavior: 'smooth' });
                setTimeout(() => {
                    window.location.href = "/kyc-verification/";
                }, 3000);
            } else {
                showMessage(data.error || "KYC submission failed!", "red");
                // Scroll to top to show error message
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        } catch (err) {
            showMessage("An unexpected error occurred. Please try again later.", "red");
            console.error(err);
        }
    });

    function showMessage(text, color) {
        messageContainer.textContent = text;
        messageContainer.style.display = "block";
        messageContainer.style.backgroundColor = color;
        messageContainer.style.color = "white";

        // hide after 3 seconds
        setTimeout(() => {
            messageContainer.style.display = "none";
        }, 3000);
    }
});
</script>

<script src="{% static 'kycWorkingType.js' %}"></script>


</body>

</html>
